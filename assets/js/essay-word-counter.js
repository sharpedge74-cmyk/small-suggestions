const fileInput=document.getElementById("fileInput"),textInput=document.getElementById("textInput");function debounce(t,n=300){let o;return(...e)=>{clearTimeout(o),o=setTimeout(()=>t(...e),n)}}const onChange=debounce(e=>processData(e),300);function processData(e){analyzeCounts(e),analyzeCapitalization(e),analyzePunctuation(e),analyzeSentenceStats(e),analyzeLexicalStats(e),populateFrequencyListFromText(e),calculateTimeEstimates(e)}async function analyzeCounts(e){await Promise.resolve();var t=(e.match(/\b\w+\b/g)||[]).length,n=e.length,o=(e.match(/[^\.!?]+[\.!?]+/g)||[]).length,a=(e.split(/\n{2,}/)||[]).filter(e=>e.trim()).length,l=e.split(/\n/).length,s=(e.match(/ /g)||[]).length,e=new Set(e.match(/\b\w+\b/g)||[]).size,c=Math.ceil(t/300);document.getElementById("wordCount").textContent=t,document.getElementById("charCount").textContent=n,document.getElementById("sentenceCount").textContent=o,document.getElementById("uniqueWords").textContent=e,document.getElementById("paragraphs").textContent=a,document.getElementById("lines").textContent=l,document.getElementById("spaces").textContent=s,document.getElementById("pageEstimates").textContent=c}async function analyzePunctuation(e){await Promise.resolve();var t,n,e={period:(e.match(/\./g)||[]).length,comma:(e.match(/,/g)||[]).length,questionMark:(e.match(/\?/g)||[]).length,colon:(e.match(/:/g)||[]).length,semicolon:(e.match(/;/g)||[]).length,apostrophe:(e.match(/'/g)||[]).length,quotationMarks:(e.match(/["“”]/g)||[]).length,hyphen:(e.match(/-/g)||[]).length,dash:(e.match(/—/g)||[]).length,parentheses:(e.match(/[()]/g)||[]).length,brackets:(e.match(/[\[\]]/g)||[]).length,braces:(e.match(/[{}]/g)||[]).length,slash:(e.match(/\//g)||[]).length,backslash:(e.match(/\\/g)||[]).length,exclamationMarks:(e.match(/!/g)||[]).length,ellipsis:(e.match(/\.{3}/g)||[]).length};for([t,n]of Object.entries(e)){var o=document.getElementById(t+"Count");o&&(o.textContent=n)}}function calculateWordFrequencies(e){const t={};e=e.toLowerCase().match(/\b[a-zA-Z']+\b/g);return e&&e.forEach(e=>{t[e]=(t[e]||0)+1}),t}function populateFrequencyListFromText(e){e=calculateWordFrequencies(e);const o=document.getElementById("frequency-scroller");o.innerHTML="",Object.entries(e).sort((e,t)=>t[1]-e[1]).slice(0,10).forEach(([e,t])=>{var n=document.createElement("div");n.className="word-item",n.innerHTML=`
        <span class="word-text">${e}</span>
        <span class="word-count">${t}</span>
      `,o.appendChild(n)})}async function analyzeCapitalization(e){displayMistakes(findCapitalizationMistakes(e))}function findCapitalizationMistakes(e){const s=[];return e.split("\n").forEach((a,l)=>{if(a.trim()){var e=a.split(/(\s+)/);let n=0,o=0;e.forEach(e=>{var t;e.trim()&&(t=a.indexOf(e,o),o=t+e.length,n++,t=getExpectedCapitalization(e,t,a))&&e!==t&&s.push({incorrect:e,corrected:t,line:l+1,position:n})})}}),s}function getExpectedCapitalization(e,t,n){var o;return!/^[A-Z]/.test(e)&&e!==e.toUpperCase()&&(n=n.substring(0,t),t=0===t,n=/[.!?]["')\]]?\s*$/.test(n),o="i"===e.toLowerCase()&&"i"===e,t||n||o)?e.charAt(0).toUpperCase()+e.slice(1):null}function displayMistakes(e){const n=document.getElementById("capitalization-issues");n.innerHTML="",0===e.length?n.innerHTML='<div class="no-issues">No capitalization issues found!</div>':e.sort((e,t)=>e.line-t.line||e.position-t.position).forEach(e=>{var t=document.createElement("div");t.className="issue-card",t.innerHTML=`
            <div class="issue-text">
                <span class="incorrect">${e.incorrect}</span>
                <span>→</span>
                <span class="correct">${e.corrected}</span>
            </div>
            <div class="issue-location">
                Line ${e.line}, Pos ${e.position}
                <button class="jump-btn" 
                        onclick="jumpToError(${e.line}, ${e.position})">
                    ↗ Jump
                </button>
            </div>
        `,n.appendChild(t)})}function jumpToError(t,n){var e=document.getElementById("textInput"),o=e.value.split("\n");let a=0;for(let e=0;e<t-1;e++)a+=o[e].length+1;var l=o[t-1].split(/\s+/);for(let e=0;e<n-1;e++)a+=l[e].length+(0<e?1:0);e.focus(),e.setSelectionRange(a,a+l[n-1].length),e.scrollTop=e.scrollHeight*((t-1)/o.length)}async function analyzeSentenceStats(e){await Promise.resolve();e=(e.match(/[^\.!?]+[\.!?]+/g)||[]).map(e=>e.trim()).filter(e=>e.length);if(0===e.length)document.getElementById("LongestSentence").textContent="-",document.getElementById("longestSentenceLeangth").textContent="0",document.getElementById("shortestSentence").textContent="-",document.getElementById("shortestSentenceLeangth").textContent="0",document.getElementById("averageSentenceCharacters").textContent="0",document.getElementById("averageSentenceWords").textContent="0",["oneToFive","sixToTen","elevenToFifteen","sixteenToTwenty","twentyOnePlus"].forEach(e=>document.getElementById(e).textContent="0");else{var e=e.map(e=>{var t=(e.match(/\b\w+\b/g)||[]).length;return{text:e,words:t,chars:e.length}}),t=e.reduce((e,t)=>t.words>e.words?t:e),n=e.reduce((e,t)=>t.words<e.words?t:e),o=e.reduce((e,t)=>e+t.chars,0),a=e.reduce((e,t)=>e+t.words,0),o=(o/e.length).toFixed(2),a=(a/e.length).toFixed(2);const l={oneToFive:0,sixToTen:0,elevenToFifteen:0,sixteenToTwenty:0,twentyOnePlus:0};e.forEach(e=>{e.words<=5?l.oneToFive++:e.words<=10?l.sixToTen++:e.words<=15?l.elevenToFifteen++:e.words<=20?l.sixteenToTwenty++:l.twentyOnePlus++}),document.getElementById("LongestSentence").textContent=t.text,document.getElementById("longestSentenceLeangth").textContent=t.words,document.getElementById("shortestSentence").textContent=n.text,document.getElementById("shortestSentenceLeangth").textContent=n.words,document.getElementById("averageSentenceCharacters").textContent=o,document.getElementById("averageSentenceWords").textContent=a,document.getElementById("oneToFive").textContent=l.oneToFive,document.getElementById("sixToTen").textContent=l.sixToTen,document.getElementById("elevenToFifteen").textContent=l.elevenToFifteen,document.getElementById("sixteenToTwenty").textContent=l.sixteenToTwenty,document.getElementById("twentyOnePlus").textContent=l.twentyOnePlus}}function analyzeLexicalStats(t){var e=(t.match(/\b\w+\b/g)||[]).map(e=>e.toLowerCase()),n=e.length,o=new Set(e),a=e.reduce((e,t)=>e+t.length,0),a=0===n?0:(a/n).toFixed(2),l=e.reduce((e,t)=>e+countSyllables(t),0);const s=new Set(["a","an","the","in","on","at","of","for","with","is","are","was","were","be","been","has","had","to","do","did","does","by","and","or","but","so","because","than","as","if","then","from","that"]);var c=e.filter(e=>s.has(e)).length,i=0===n?0:((n-c)/n*100).toFixed(2);const r=new Set(["like","you know","basically","actually","literally","just","sort of","kind of"]);var d=e.filter(e=>r.has(e)).length,o=0===n?0:(o.size/n).toFixed(2);const m={};e.forEach(e=>m[e]=(m[e]||0)+1);var n=Object.keys(m).filter(e=>1===m[e]),u=[...new Set(e.filter(e=>s.has(e)))],g=[...new Set(Array.from(r).filter(e=>new RegExp(`\\b${e}\\b`,"i").test(t)))];let h="";e.forEach(e=>{e.length>h.length&&(h=e)}),document.getElementById("sykkableCount").textContent=l,document.getElementById("averageWordLength").textContent=a,document.getElementById("lexicalDenisty").textContent=i+"%",document.getElementById("ttr").textContent=o,document.getElementById("fillerWordsCount").textContent=d,document.getElementById("stopWordsCount").textContent=c,document.getElementById("hapaxLegomenaLeangth").textContent=n.length,document.getElementById("hapaxLegomena").textContent=n.join(", "),document.getElementById("longestWord").textContent=h||"-",document.getElementById("longestWordChar").textContent=h.length||"0",document.getElementById("stopWordsUsedCount").textContent=u.length,document.getElementById("stopWords").textContent=0<u.length?u.join(", "):"-",document.getElementById("fillerWordsUsedCount").textContent=g.length,document.getElementById("fillerWords").textContent=0<g.length?g.join(", "):"-"}function countSyllables(e){return!((e=e.toLowerCase()).length<=3)&&((e=(e=e.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/,"")).replace(/^y/,"")).match(/[aeiouy]{1,2}/g)||[]).length||1}function calculateTimeEstimates(e){e=(e.match(/\b[a-zA-Z']+\b/g)||[]).length;const n={readingTime:e/200,speakingTime:e/130,typingTime:e/40,handwritingTime:e/20,proofreadingTime:e/100,translationTime:e/30};Object.keys(n).forEach(e=>{var t=n[e];document.getElementById(e).textContent=t<1?Math.ceil(60*t)+" sec":t.toFixed(1)+" min"})}function exportToTXT(){var e=textInput.value,e=new Blob([e],{type:"text/plain"}),t=document.createElement("a");t.download="text-analysis.txt",t.href=URL.createObjectURL(e),t.click()}function exportToWord(){var e=`<pre>${textInput.value}</pre>`,e=new Blob(["\ufeff",`
        <html xmlns:o='urn:schemas-microsoft-com:office:office' 
              xmlns:w='urn:schemas-microsoft-com:office:word' 
              xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Export HTML to Word Document</title></head><body>`+e+"</body></html>"],{type:"application/msword"}),t=document.createElement("a");t.download="text-analysis.doc",t.href=URL.createObjectURL(e),t.click()}function exportToPDF(){var e=window.jspdf["jsPDF"],e=new e,t=textInput.value,t=e.splitTextToSize(t,180);e.text(t,10,20),e.save("text-analysis.pdf")}fileInput.addEventListener("change",e=>{e=e.target.files[0];if(e&&"text/plain"===e.type){const t=new FileReader;t.onload=()=>{textInput.value=t.result,processData(t.result)},t.readAsText(e)}else alert("Please upload a valid .txt file.")}),textInput.addEventListener("input",e=>{onChange(e.target.value)});